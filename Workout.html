<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dunamis - Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 text-gray-800 pb-24">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <img src="/assets/logo.png" alt="Logo" class="w-20 h-20 mx-auto mb-4 rounded-full">
            <h1 class="text-4xl font-bold text-gray-900">Workout Tracker</h1>
            <p id="current-user-display" class="text-gray-600 mt-2">Loading user...</p>
            <div class="mt-4 flex justify-center items-center gap-4 flex-wrap">
                <a href="index.html" class="text-blue-600 hover:underline">Planner</a>
                <a href="Workout.html" class="text-blue-600 hover:underline">Tracker</a>
                <a href="analysis.html" class="text-blue-600 hover:underline">Analysis</a>
                <a href="Users.html" class="text-blue-600 hover:underline">Manage Athletes</a>
                <a href="/logout" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Logout</a>
            </div>
        </header>

        <div class="flex flex-col sm:flex-row justify-center items-end gap-4 p-4 bg-white rounded-xl shadow-md border mb-8 flex-wrap">
            
            <!-- Athlete Selector (for Coach View) -->
            <div id="athlete-selector-wrapper" class="hidden">
                <label for="coach-user-selector" class="block text-sm font-medium text-gray-700 text-center sm:text-left">Athlete</label>
                <select id="coach-user-selector" class="mt-1 px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full sm:w-auto"></select>
            </div>

            <!-- Workout Selector -->
            <div>
                <label for="plan-selector" class="block text-sm font-medium text-gray-700 text-center sm:text-left">Workout</label>
                <select id="plan-selector" class="mt-1 px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full sm:w-auto">
                    <option value="">-- Loading... --</option>
                </select>
            </div>

            <!-- Load Button -->
            <div>
                <button id="load-plan-button" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 w-full sm:w-auto">
                    Load Workout
                </button>
            </div>

        </div>
        
        <div id="workout-area" class="bg-white p-6 rounded-xl shadow-lg border">
             <p id="workout-placeholder" class="text-center text-gray-500 py-12">Select a workout to begin tracking.</p>
        </div>

        <div id="action-buttons" class="fixed bottom-0 left-0 right-0 bg-white bg-opacity-95 p-4 border-t shadow-lg flex justify-center gap-4 z-50 hidden">
             <!-- Action buttons will be added here -->
        </div>
    </div>

<script type="module">
    // --- CONFIGURATION ---
    const GET_CURRENT_USER_URL = '/api/get_current_user';
    const GET_ATHLETES_URL = '/api/get_athletes';
    const GET_WORKOUT_LIST_URL = '/api/list_workouts_for_tracker';
    const GET_WORKOUT_URL = '/api/get_workout';
    const SAVE_PROGRESS_URL = '/api/save_progress';
    const COMPLETE_WORKOUT_URL = '/api/complete_workout';
    const GET_EXERCISE_HISTORY_URL = '/api/get_exercise_history';
    
    // --- DOM ELEMENTS ---
    const currentUserDisplay = document.getElementById('current-user-display');
    const athleteSelectorWrapper = document.getElementById('athlete-selector-wrapper');
    const coachUserSelector = document.getElementById('coach-user-selector');
    const planSelector = document.getElementById('plan-selector');
    const loadPlanButton = document.getElementById('load-plan-button');
    const workoutArea = document.getElementById('workout-area');
    const actionButtons = document.getElementById('action-buttons');

    // --- STATE ---
    let currentUser = null;
    let userRole = null;
    let currentPlanFilename = null;

    // --- INITIALIZATION ---
    async function initializePage() {
        try {
            const response = await fetch(GET_CURRENT_USER_URL);
            if (!response.ok) throw new Error(`Failed to fetch user data: ${response.statusText}`);
            const data = await response.json();
            currentUser = data.username;
            userRole = data.role;
            currentUserDisplay.textContent = `Logged in as: ${currentUser} (${userRole})`;

            if (userRole === 'coach') {
                await setupCoachView();
            } else {
                await loadWorkoutListFromServer(currentUser);
            }
            await checkForPreload();
        } catch (error) {
            console.error("Initialization failed:", error);
            currentUserDisplay.textContent = "Error: Could not load user data.";
        }
    }

    // --- COACH VIEW ---
    async function setupCoachView() {
        // Step 1: Make the athlete selector visible and set a default message for the workout list.
        athleteSelectorWrapper.classList.remove('hidden');
        planSelector.innerHTML = '<option value="">-- Select an Athlete First --</option>';
        
        try {
            // Step 2: Fetch the list of athletes from the server.
            const response = await fetch(GET_ATHLETES_URL);
            if (!response.ok) throw new Error('Failed to fetch athlete list');
            const data = await response.json();
            
            // Step 3: Populate the athlete dropdown if athletes are found.
            if (data.status === 'success' && data.athletes.length > 0) {
                coachUserSelector.innerHTML = '<option value="">-- Select an Athlete --</option>';
                data.athletes.forEach(athlete => coachUserSelector.add(new Option(athlete, athlete)));
                
                // Step 4: Add an event listener that updates the workout list when an athlete is chosen.
                coachUserSelector.addEventListener('change', () => {
                    const selectedAthlete = coachUserSelector.value;
                    if (selectedAthlete) {
                        loadWorkoutListFromServer(selectedAthlete);
                    } else {
                        planSelector.innerHTML = '<option value="">-- Select an Athlete First --</option>';
                    }
                });
            } else {
                 coachUserSelector.innerHTML = '<option value="">-- No Athletes Found --</option>';
            }
        } catch(e) {
            console.error(e);
            coachUserSelector.innerHTML = '<option value="">-- Error Loading Athletes --</option>';
        }
    }

    // --- DATA LOADING ---
    async function loadWorkoutListFromServer(user) {
        planSelector.innerHTML = '<option value="">-- Loading Workouts... --</option>';
        try {
            const response = await fetch(`${GET_WORKOUT_LIST_URL}?user=${user}`);
            if (!response.ok) throw new Error('Failed to fetch workouts');
            const data = await response.json();
            planSelector.innerHTML = '';

            if (data.tracked?.length > 0 || data.plans?.length > 0) {
                planSelector.add(new Option('-- Select a Workout to Start or Resume --', ''));
                if (data.tracked.length > 0) {
                    const group = document.createElement('optgroup');
                    group.label = 'In Progress';
                    data.tracked.forEach(plan => group.appendChild(new Option(plan.replace('_tracked.csv','').replace(/_/g, ' ') + ' (Resume)', `tracked:${plan}`)));
                    planSelector.add(group);
                }
                if (data.plans.length > 0) {
                    const group = document.createElement('optgroup');
                    group.label = 'New Workouts';
                    data.plans.forEach(plan => group.appendChild(new Option(plan.replace('.csv','').replace(/_/g, ' '), `plan:${plan}`)));
                    planSelector.add(group);
                }
            } else {
                planSelector.innerHTML = '<option value="">-- No Workouts Found --</option>';
            }
        } catch (error) {
            console.error('Error loading workout list:', error);
            planSelector.innerHTML = '<option value="">-- Error Loading --</option>';
        }
    }

    async function checkForPreload() {
        const urlParams = new URLSearchParams(window.location.search);
        const planToLoad = urlParams.get('plan');
        if (planToLoad) {
            const athleteName = planToLoad.split('_')[0];
            if(userRole === 'coach'){
                coachUserSelector.value = athleteName;
                await loadWorkoutListFromServer(athleteName);
            } else {
                await loadWorkoutListFromServer(currentUser);
            }
            planSelector.value = `plan:${planToLoad}`;
            if(planSelector.value === `plan:${planToLoad}`){
                 loadWorkout('plan', planToLoad);
            }
        }
    }
    
    // --- WORKOUT LOGIC ---
    async function loadWorkout(type, filename) {
        if (!type || !filename) {
            workoutArea.innerHTML = '<p class="text-center text-gray-500 py-12">Select a workout to begin tracking.</p>';
            actionButtons.classList.add('hidden');
            return;
        }
        
        workoutArea.innerHTML = `<p class="text-center text-gray-500 py-12">Loading workout: ${filename.replace('.csv','').replace(/_/g, ' ')}...</p>`;
        currentPlanFilename = filename.replace('_tracked.csv', '.csv');
        
        try {
            const response = await fetch(`${GET_WORKOUT_URL}?type=${type}&filename=${filename}`);
            if(!response.ok) throw new Error("Could not load workout file.");
            const csvText = await response.text();
            const athleteName = userRole === 'coach' ? coachUserSelector.value : currentUser;
            await renderWorkout(csvText, athleteName, filename);
        } catch(e) {
            console.error(e);
            workoutArea.innerHTML = `<p class="text-red-500 text-center">${e.message}</p>`;
        }
    }

    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
        return lines.slice(1).map(line => {
            const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
            return headers.reduce((obj, header, i) => {
                obj[header] = values[i] || '';
                return obj;
            }, {});
        });
    }

    async function renderWorkout(csvText, athleteName, filename) {
        const rows = parseCSV(csvText);
        let html = `<h2 class="text-2xl font-bold text-center mb-6">${filename.replace(/_tracked\.csv|\.csv/g,'').replace(/_/g, ' ')}</h2>`;
        
        let currentSupersetGroup = null;
        let currentExercise = null;
        let firstAthleteNote = rows.length > 0 ? rows[0]['Athlete Notes'] || '' : '';

        for (const row of rows) {
            const supersetGroup = (row['Superset Group'] && row['Superset Group'].toLowerCase() !== 'none' && row['Superset Group'] !== '') ? row['Superset Group'] : null;
            
            if (currentExercise && row.Exercise !== currentExercise) {
                html += `<div class="mt-4"><label class="block text-sm font-medium text-gray-700">Athlete Notes:</label><textarea class="athlete-notes-input w-full p-2 border rounded-md" rows="2" placeholder="How did this exercise feel?">${firstAthleteNote}</textarea></div></div></div>`;
            }
            if (currentSupersetGroup && supersetGroup !== currentSupersetGroup) {
                html += `</div>`;
            }

            if (supersetGroup && supersetGroup !== currentSupersetGroup) {
                html += `<div class="p-4 rounded-lg bg-indigo-50 border border-indigo-200 mb-6">
                         <h4 class="text-lg font-bold text-indigo-700 mb-4">Superset ${supersetGroup}</h4>`;
            }
            
            if (row.Exercise !== currentExercise) {
                firstAthleteNote = row['Athlete Notes'] || '';
                const historyHtml = await getExerciseHistoryHtml(athleteName, row.Exercise);
                html += `<div class="mb-4 exercise-block" data-exercise-name="${row.Exercise}">
                            <h3 class="text-xl font-semibold mb-1 border-b pb-2">${row.Exercise}</h3>
                            ${historyHtml}
                            <div class="space-y-3">`;
            }
            
            html += createSetHtml(row);
            
            currentExercise = row.Exercise;
            currentSupersetGroup = supersetGroup;
        }

        if (currentExercise) html += `<div class="mt-4"><label class="block text-sm font-medium text-gray-700">Athlete Notes:</label><textarea class="athlete-notes-input w-full p-2 border rounded-md" rows="2" placeholder="How did this exercise feel?">${firstAthleteNote}</textarea></div></div></div>`;
        if (currentSupersetGroup) html += `</div>`;
        
        workoutArea.innerHTML = html;
        actionButtons.innerHTML = `<button id="save-progress-button" class="px-6 py-3 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600">Save Progress</button><button id="complete-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">Complete Workout</button>`;
        actionButtons.classList.remove('hidden');
        document.getElementById('save-progress-button').addEventListener('click', () => saveOrComplete('inprogress'));
        document.getElementById('complete-button').addEventListener('click', () => saveOrComplete('finished'));
    }

    function createSetHtml(row) {
        const actualReps = row['Actual Reps'] || row['Target Reps'];
        const actualWeight = row['Actual Weight (lb)'] || row['Target Weight (lb)'];
        const coachNotes = row["Coach's Notes"] || '';
        const rir = row['RIR'] || '';

        return `<div class="grid grid-cols-12 gap-x-3 gap-y-2 items-center p-2 rounded-lg bg-gray-50 set-row" 
                     data-set="${row.Set}" 
                     data-target-reps="${row['Target Reps']}" 
                     data-target-weight-lb="${row['Target Weight (lb)']}" 
                     data-notes="${coachNotes}"
                     data-superset-group="${row['Superset Group']}">
            <div class="col-span-12 sm:col-span-1 text-sm font-semibold text-gray-600">Set ${row.Set}</div>
            <div class="col-span-6 sm:col-span-2"><label class="block text-xs font-medium text-gray-500">Actual Reps</label><input type="text" value="${actualReps}" class="actual-reps w-full p-2 border rounded-md" placeholder="Reps"></div>
            <div class="col-span-6 sm:col-span-2"><label class="block text-xs font-medium text-gray-500">Actual Weight</label><input type="number" value="${actualWeight}" class="actual-weight w-full p-2 border rounded-md" placeholder="Weight"></div>
            <div class="col-span-6 sm:col-span-2"><label class="block text-xs font-medium text-gray-500">RIR</label><input type="number" value="${rir}" class="rir-input w-full p-2 border rounded-md" placeholder="RIR"></div>
            <div class="col-span-6 sm:col-span-5"><label class="block text-xs font-medium text-gray-500">Coach's Notes</label><input type="text" value="${coachNotes}" class="coach-notes w-full p-2 border rounded-md" placeholder="Notes" disabled></div>
        </div>`;
    }

    async function getExerciseHistoryHtml(athleteName, exName) {
        try {
            const historyRes = await fetch(`${GET_EXERCISE_HISTORY_URL}?user=${athleteName}&exercise=${encodeURIComponent(exName)}`);
            if (!historyRes.ok) throw new Error('History fetch failed');
            const historyData = await historyRes.json();
            if (historyData.status === 'success' && historyData.history) {
                const { date, sets } = historyData.history;
                const setsStrings = sets.map(s => `${s['Actual Reps']}x${s['Actual Weight (lb)']}lb`);
                return `<p class="text-xs text-gray-500 mb-2"><strong>Last time on ${new Date(date + 'T00:00:00').toLocaleDateString()}:</strong> ${setsStrings.join(', ')}</p>`;
            }
        } catch (e) {
            console.error(`Failed to fetch history for ${exName}`, e);
            return '<p class="text-xs text-red-500 mb-2">Error loading history.</p>';
        }
        return '<p class="text-xs text-gray-500 mb-2 italic">No prior history found.</p>';
    }
    
    function getTrackedDataAsCSV() {
        const headers = "Exercise,Set,Target Reps,Target Weight (lb),Superset Group,Coach's Notes,Actual Reps,Actual Weight (lb),RIR,Athlete Notes\n";
        let csvRows = [];
        const exercises = workoutArea.querySelectorAll('.exercise-block');
        if (exercises.length === 0) return null;
        
        exercises.forEach(exBlock => {
            const exName = exBlock.dataset.exerciseName;
            const athleteNotes = exBlock.querySelector('.athlete-notes-input').value.replace(/,/g, ';');
            exBlock.querySelectorAll('.set-row').forEach(setRow => {
                const { set, targetReps, targetWeightLb, notes, supersetGroup } = setRow.dataset;
                const actualReps = setRow.querySelector('.actual-reps').value;
                const actualWeight = setRow.querySelector('.actual-weight').value;
                const rir = setRow.querySelector('.rir-input').value;
                csvRows.push(`"${exName}","${set}","${targetReps}","${targetWeightLb}","${supersetGroup}","${(notes || '').replace(/,/g, ';')}","${actualReps}","${actualWeight}","${rir}","${athleteNotes}"`);
            });
        });
        return headers + csvRows.join('\n');
    }

    async function saveOrComplete(type) {
        const csv_content = getTrackedDataAsCSV();
        if (!csv_content) { return alert('Cannot save an empty workout.'); }
        const tracked_filename = currentPlanFilename.replace('.csv', '_tracked.csv');
        let url, body, successMessage;
        if (type === 'finished') {
            url = COMPLETE_WORKOUT_URL;
            body = { plan_filename: currentPlanFilename, tracked_filename, csv_content };
            successMessage = 'Workout Completed!';
        } else {
            url = SAVE_PROGRESS_URL;
            body = { filename: tracked_filename, csv_content };
            successMessage = 'Progress Saved!';
        }
        try {
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);
            alert(successMessage);
            if(type === 'finished') window.location.href = 'index.html';
        } catch(e) {
            alert(`Error: ${e.message}`);
        }
    }

    // --- EVENT LISTENERS ---
    loadPlanButton.addEventListener('click', () => {
        const selected = planSelector.value;
        if(selected){
            const [type, filename] = selected.split(':', 2);
            loadWorkout(type, filename);
        }
    });

    // --- INITIALIZATION CALL ---
    initializePage();
</script>
</body>
</html>

