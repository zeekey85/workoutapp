<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Workout Progress Analysis</h1>
            <p class="text-gray-600 mt-2">Visualize your performance over time.</p>
            <a href="index.html" class="text-blue-600 hover:underline">Go to Planner</a>
            <a href="Workout.html" class="text-blue-600 hover:underline ml-4">Go to Tracker</a>
        </header>

        <div class="flex flex-col sm:flex-row justify-center items-center gap-4 p-4 bg-white rounded-xl shadow-md border mb-8">
            <select id="user-selector" class="px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full sm:w-auto">
                <option value="">-- Select a User --</option>
                <option value="All">All Users</option>
                <option value="Zak">Zak</option>
                <option value="Kate">Kate</option>
            </select>
            <select id="exercise-selector" class="px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full sm:w-auto" disabled>
                <option value="">-- Select a User First --</option>
            </select>
            <p id="statusMessage" class="text-sm font-medium h-5 flex-grow text-center sm:text-left"></p>
        </div>

        <main id="charts-container" class="space-y-8 hidden">
            <!-- Max Weight Chart -->
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <h2 id="max-weight-title" class="text-2xl font-semibold mb-4">Max Weight Lifted vs. Workout</h2>
                <canvas id="max-weight-chart"></canvas>
            </div>
            <!-- Total Volume Chart -->
            <div class="bg-white p-6 rounded-xl shadow-lg border">
                <h2 id="total-volume-title" class="text-2xl font-semibold mb-4">Total Volume vs. Workout</h2>
                <canvas id="total-volume-chart"></canvas>
            </div>
        </main>
        
        <div id="empty-state" class="text-center py-16 text-gray-500 bg-white rounded-xl shadow-lg border">
             <p class="text-lg font-semibold">Please select a user to view their progress.</p>
        </div>

    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const ANALYSIS_URL = `/api/get_analysis`;

        // --- DOM ELEMENTS ---
        const userSelector = document.getElementById('user-selector');
        const exerciseSelector = document.getElementById('exercise-selector');
        const statusMessage = document.getElementById('statusMessage');
        const chartsContainer = document.getElementById('charts-container');
        const emptyState = document.getElementById('empty-state');
        const maxWeightTitle = document.getElementById('max-weight-title');
        const totalVolumeTitle = document.getElementById('total-volume-title');
        
        let analysisData = {};
        let weightChart = null;
        let volumeChart = null;

        // --- EVENT LISTENERS ---
        window.addEventListener('load', loadAnalysisData);
        userSelector.addEventListener('change', handleUserSelection);
        exerciseSelector.addEventListener('change', updateCharts);

        async function loadAnalysisData() {
            showStatus('Fetching analysis from server...', 'blue');
            try {
                const response = await fetch(ANALYSIS_URL);
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();

                if (data.status === 'success' && Object.keys(data.analysis).length > 0) {
                    analysisData = data.analysis;
                    showStatus('Analysis data loaded. Please select a user.', 'green');
                } else {
                    emptyState.innerHTML = `<p class="text-lg font-semibold">No analysis data found.</p><p class="text-sm">Complete some workouts with the tracker app first.</p>`;
                    showStatus('No data available for analysis.', 'orange');
                }
            } catch (error) {
                console.error('Failed to load analysis:', error);
                emptyState.innerHTML = `<p class="text-lg font-semibold">Error loading data.</p><p class="text-sm">Could not connect to the server. Is it running?</p>`;
                showStatus('Error connecting to server.', 'red');
            }
        }

        function handleUserSelection() {
            const selectedUser = userSelector.value;
            if (!selectedUser) {
                exerciseSelector.innerHTML = '<option value="">-- Select a User First --</option>';
                exerciseSelector.disabled = true;
                chartsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            populateExerciseSelector();
            updateCharts();
        }
        
        function populateExerciseSelector() {
            const selectedUser = userSelector.value;
            const allExercises = Object.keys(analysisData).sort();
            
            let userExercises = new Set();
            if (selectedUser === 'All') {
                allExercises.forEach(ex => userExercises.add(ex));
            } else {
                allExercises.forEach(ex => {
                    if (analysisData[ex].users.includes(selectedUser)) {
                        userExercises.add(ex);
                    }
                });
            }

            const sortedUserExercises = Array.from(userExercises);
            exerciseSelector.innerHTML = ''; // Clear previous options
            if (sortedUserExercises.length > 0) {
                sortedUserExercises.forEach(ex => {
                    const option = document.createElement('option');
                    option.value = ex;
                    option.textContent = ex;
                    exerciseSelector.appendChild(option);
                });
                exerciseSelector.disabled = false;
            } else {
                exerciseSelector.innerHTML = '<option value="">-- No exercises for this user --</option>';
                exerciseSelector.disabled = true;
            }
        }

        function updateCharts() {
            const selectedUser = userSelector.value;
            const selectedExercise = exerciseSelector.value;
            
            if (weightChart) weightChart.destroy();
            if (volumeChart) volumeChart.destroy();

            if (!selectedExercise || !analysisData[selectedExercise]) {
                chartsContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            chartsContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');
            const fullExerciseData = analysisData[selectedExercise];
            
            const filteredData = { labels: [], dates: [], max_weight: [], total_volume: [] };

            for (let i = 0; i < fullExerciseData.labels.length; i++) {
                if (selectedUser === 'All' || fullExerciseData.users[i] === selectedUser) {
                    filteredData.labels.push(fullExerciseData.labels[i]);
                    filteredData.dates.push(fullExerciseData.dates[i]);
                    filteredData.max_weight.push(parseFloat(fullExerciseData.max_weight[i]) || 0);
                    filteredData.total_volume.push(parseFloat(fullExerciseData.total_volume[i]) || 0);
                }
            }

            // Update chart titles
            maxWeightTitle.textContent = `Max Weight Lifted for ${selectedExercise}`;
            totalVolumeTitle.textContent = `Total Volume for ${selectedExercise}`;

            // Create Max Weight Chart
            const weightCtx = document.getElementById('max-weight-chart').getContext('2d');
            weightChart = new Chart(weightCtx, {
                type: 'line',
                data: {
                    labels: filteredData.labels.map((label, i) => `Workout ${label} (${filteredData.dates[i]})`),
                    datasets: [{
                        label: 'Max Weight (kg)',
                        data: filteredData.max_weight,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                    }]
                },
                options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Weight (kg)' } } } }
            });

            // Create Total Volume Chart
            const volumeCtx = document.getElementById('total-volume-chart').getContext('2d');
            volumeChart = new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: filteredData.labels.map((label, i) => `Workout ${label} (${filteredData.dates[i]})`),
                    datasets: [{
                        label: 'Total Volume (kg)',
                        data: filteredData.total_volume,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgb(153, 102, 255)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Total Volume (Reps x Weight)' } } } }
            });
        }

        function showStatus(message, color) {
            statusMessage.textContent = message;
            statusMessage.className = `text-sm font-medium h-5 text-${color}-600`;
            if (color !== 'blue') {
                setTimeout(() => { if (statusMessage.textContent === message) statusMessage.textContent = ''; }, 4000);
            }
        }
    </script>
</body>
</html>
